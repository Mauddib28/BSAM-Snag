---
layout: control
title: BSAM-SE-02
summary: Hidden GATT Bluetooth services
description: Check that your Bluetooth device lists all available services in GATT. This is important to prevent an attacker from being able to hide services and access them without your knowledge or consent
parent: Services
grand_parent: Controls
nav_order: 2
lang: en
page_id: cont_services_02
permalink: controls/hidden-gatt-bluetooth-services/
tags:
- BR/EDR
- BLE
---

In Bluetooth, a service refers to a specific functionality or feature that a device offers to other devices within a Bluetooth network. Each service is identified by a Universally Unique Identifier (UUID), and can be discovered and used by other Bluetooth devices that support that particular service.

In Bluetooth there are multiple ways to discover available services in a device. One of the mechanisms to perform this discovery is the _Generic Attribute Profile_ or _GATT_ and allows communication between devices through the exchange of attributes (data organized in a specific format).

It is mandatory _GATT_ is present, it is important that it is correcly configured and that lists all the available services in the device. Failing to list a service in _GATT_ does not prevent users from accesing it and does not secure it.

On the same topic, if a service is correctly secured, there is no need to hide it and correctly configuring _GATT_ to list it will be in conformance with Bluetooth Specifications, allowing for better device interoperability.


## Description

In order to check if there are hidden services it is important to perform a _GATT_ discovery. This is an standard Bluetooth procedure that can be performed with standard bluetooth tools.

After having a list of available _GATT_ services, it is needed to perform alternative ways of discovering Bluetooth services. This can include the following procedures:

* Capturing Bluetooth communications while operating the device to discover communications with previously unknown services.
* Performing bruteforce scans of services in a device.
* Performing service scans using different service discovery protocols such as the SDP if available.

If there are services hidden to the _GATT_ service it is not correctly configured.


## Related resources

To check this control, the following resources may be useful:

{% include res_table.md resources='BSAM-RES-04,BSAM-RES-05' %}

## Example case

The existence of hidden GATT services in a device with BLE connectivity will be tested. The tests will be carried out on a laptop. We will use Wireshark with [BTVS](https://learn.microsoft.com/es-es/windows-hardware/drivers/bluetooth/testing-btp-tools-btvs) (btvs.exe -Mode wireshark) to capture packets for analysis.

For this control it will be necessary to have [python 3](https://www.python.org/downloads/windows/) installed.
From a terminal it will be necessary to install the packages asyncio and bleak with the python installation wizard _pip_.

`pip install asyncio`.

`pip install bleak`.

To perform the search for _Service_ exposed by GATT, the bleak script [service_explorer.py](https://github.com/hbldh/bleak/blob/develop/examples/service_explorer.py) will be used.

To run it it is necessary to know the MAC address of the target device and type the command:

`python service_explorer.py --address XX:XX:XX:XX:XX:XX:XX:XX:XX >> gatt_explorer.txt`.

A file (_gatt_explorer.txt_) with the traces generated by the _service_explorer.py_ script is available and sorted for easy reading.

![gatt_explorer.txt sorted]({{ '/assets/img/bsam-se-02_gatt_profiler.png' | relative_url}})

For each service (_Service_) there is one or more characteristics (_Characteristic_) containing one or more descriptors (_Descriptor_) and a value (_Value_). The services, characteristics and descriptors have two additional fields: the _Handle_ and the _UUID_.

The Bluetooth driver internally lists the GATT services via the _Handle_ or _UUID_ field. The standard has limited, for a device, the number of services, features and descriptors to 65.535 (0xFFFF), equivalent to scrolling from value 1 to 65,535 in the _Handle_.

To check for hidden _Service_, a read request will be made with Scapy, or a similar tool like gatttool, for each _Handle_, depending on the response obtained for each query the _Handle_ will exist or not. The possible cases of response to a read request, according to the ATT protocol, will allow to know if a _Handle_ exists or not.

| Read Response | _Handle_ Exists |
|---------------|---------|
| Read Response | YES |
| Insufficient authorization error | YES |
| Insufficient authentication error | YES |
| Encryption key size too short error | YES |
| Insufficient encryption error | YES |
| Invalid _Handle_ error | NO |
| Read not permitted error | YES |

Once you have the output of the two tools, compare the results and if there are _Handle_ that are not listed with the bleak script, it means that it is a hidden service.

The check control _FAIL_ when more existing _Handle_ are found than discovered in the GATT scan.
